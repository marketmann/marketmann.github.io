window.funnelytics={cookie:"_fs",origin:"https://track.funnelytics.io",project:null,session:null,step:null,stepping:!1,steps:[],getSession:function(){var e=funnelytics.url.params.toObject(window.location.search.substr(1)),n=funnelytics.cookies.get(funnelytics.cookie);if(e[funnelytics.cookie]){var t=e[funnelytics.cookie];return funnelytics.cookies.set(funnelytics.cookie,t),t}return n},client:{isBot:function(){return new RegExp(/funnelyticsbot|googlebot|facebookexternalhit|bot|crawler|spider|robot|crawling/i).test(navigator.userAgent)}},projects:{_settings:{},_loaded:!1,getSettings:function(e){if(funnelytics.projects._loaded){var t=funnelytics.projects._settings;if(window.Promise&&!e)return new window.Promise(function(e,n){return e(t)});if(!e||"function"!=typeof e)return;e(null,t)}else{var n=new XMLHttpRequest;n.open("GET",funnelytics.origin+"/settings/"+funnelytics.project),n.setRequestHeader("Content-Type","application/json"),n.addEventListener("load",function(){var t=JSON.parse(n.responseText);if(200<=n.status&&n.status<300){if(funnelytics.projects._settings=t,funnelytics.projects._loaded=!0,window.Promise&&!e)return new window.Promise(function(e,n){return e(funnelytics.projects._settings)});if(!e||"function"!=typeof e)return;e(null,funnelytics.projects._settings)}else{if(window.Promise&&!e)return new window.Promise(function(e,n){return n(t)});if(!e||"function"!=typeof e)return;e(t)}}),n.send()}},getWhitelistedDomains:function(o){funnelytics.projects.getSettings(function(e,n){if(o&&"function"==typeof o)if(e)o(e);else{for(var t,i=[],s=0;s<n.domains.length;s++)t=n.domains[s].domain,i.push(t.slice(0,t.length-1));o(null,i)}})},addCrossDomainParameters:function(){funnelytics.projects.getWhitelistedDomains(function(e,n){for(var t,i=0;i<(t=document.getElementsByTagName("a")).length;i++)if(t[i].href&&window.location.hostname!=t[i].hostname&&(-1!=n.indexOf(t[i].hostname)||-1!=n.indexOf("www."+t[i].hostname))&&funnelytics.session&&funnelytics.url.isURL(t[i].href)){var s=funnelytics.url.params.fromURL(t[i].href,funnelytics.url.params.toArray),o=funnelytics.projects.getRevisedParameters(s);o=funnelytics.url.params.toString(o),funnelytics.url.params.regex.test(t[i].href)?t[i].href=t[i].href.replace(/\?{1}.*/,o):t[i].href=t[i].href+o}})},getRevisedParameters:function(e){for(var n=!1,t=0;t<e.length;t++)e[t].key===funnelytics.cookie&&(n=!0,funnelytics.session&&(e[t].value=funnelytics.session));return!n&&funnelytics.session&&e.push({key:funnelytics.cookie,value:funnelytics.session,hasEquals:!0}),e}},cookies:{getDomain:function(){var e=window.location.hostname.split(".");return 2<e.length&&(e=e.slice(e.length-2)),e},all:function(){for(var e,n={},t=0;t<(cookies=document.cookie.split("; ")).length;t++)n[(e=cookies[t].split("="))[0]]=e[1];return n},get:function(e){return funnelytics.cookies.all()[e]},set:function(e,n){for(var t,i=window.location.hostname.split("."),s=e+"="+n+"; path=/; ",o=null==n?"; expires=Thu, 01 Jan 1970 00:00:00 UTC;":"; expires=Thu, 01 Jan 2038 00:00:00 UTC;",r=i.length-1;-1<r&&(t=i.slice(r).join("."),document.cookie=s+"domain="+t+o,!funnelytics.cookies.get(e));r--);},remove:function(e){funnelytics.cookies.set(e)}},url:{regex:new RegExp(/.*:\/\/.*\..*/),isURL:function(e){return funnelytics.url.regex.test(e)},parse:function(e){var n=document.createElement("a");return n.href=e,n},params:{regex:new RegExp(/.*:\/\/.*\..*\?/),fromURL:function(e,n){var t=n||funnelytics.url.params.toObject,i=e.split(funnelytics.url.params.regex);return t(i=2==i.length?i[1]:null)},toObject:function(e){var n={};if(e)for(var t,i,s=0;s<(t=e.split("&")).length;s++)n[(i=t[s].split("="))[0]]=i[1];return n},toArray:function(e){var n=[];if(e)for(var t,i,s=e.split("&"),o=0;o<s.length;o++)i=-1<s[o].indexOf("="),t=s[o].split("="),n.push({key:t[0],value:t[1],hasEquals:i});return n},toString:function(e){var n,t="";0<e.length&&(t+="?");for(var i=0;i<e.length;i++)t+=(n=e[i]).key,n.hasEquals&&(t+="="),n.value&&(t+=n.value),i!==e.length-1&&(t+="&");return t}}},events:{trigger:function(e,n,t,i){var s;if(i=i||{},funnelytics.client.isBot()){if(s={message:"No human, no service."},"function"==typeof t)return void t(s);if(!i.promise)return window.Promise?new window.Promise(function(e,n){return n(s)}):void 0;i.promise.reject(s)}if("string"!=typeof e){if(s={message:"First argument must be an event name."},"function"==typeof t)return void t(s);if(!i.promise)return window.Promise?new window.Promise(function(e,n){return n(s)}):void 0;i.promise.reject(s)}if(!funnelytics.step){var o,r;if(!t&&window.Promise)o={instance:new window.Promise(function(e,n){r={resolve:e,reject:n}}),resolve:r.resolve,reject:r.reject};return o?o.instance:void 0}var u=new XMLHttpRequest;u.open("POST",funnelytics.origin+"/events/trigger"),u.setRequestHeader("Content-Type","application/json"),u.addEventListener("load",function(){if(s=JSON.parse(u.responseText),200<=u.status&&u.status<300)if("function"==typeof t)t(null,s);else{if(!i.promise)return window.Promise?new window.Promise(function(e,n){return e(s)}):void 0;i.promise.resolve(s)}else{if("function"==typeof t)return void t(s);if(!i.promise)return window.Promise?new window.Promise(function(e,n){return n(s)}):void 0;i.promise.reject(s)}}),u.send(JSON.stringify({name:e,step:funnelytics.step,session:funnelytics.session,project:funnelytics.project,attributes:n}))}},attributes:{set:function(e,n){var t,i;if("object"!=typeof e)return t={message:"First argument must be an object containing user details."},"function"==typeof n?void n(t):window.Promise?new window.Promise(function(e,n){return n(t)}):void 0;if(!(i=funnelytics.cookies.get(funnelytics.cookie)))return t={message:"No Funnelytics session exists for this user."},"function"==typeof n?void n(t):window.Promise?new window.Promise(function(e,n){return n(t)}):void 0;var s=new XMLHttpRequest;s.open("POST",funnelytics.origin+"/trackers/set"),s.setRequestHeader("Content-Type","application/json"),s.addEventListener("load",function(){if(t=JSON.parse(s.responseText),200<=s.status&&s.status<300){if("function"!=typeof n)return window.Promise?new window.Promise(function(e,n){return e(t)}):void 0;n(null,t)}else{if("function"!=typeof n)return window.Promise?new window.Promise(function(e,n){return n(t)}):void 0;n(t)}}),s.send(JSON.stringify({project:funnelytics.project,session:i,info:e}))}},functions:{initialize:function(){if(!funnelytics.client.isBot()){var n=new XMLHttpRequest;n.open("POST",funnelytics.origin+"/sessions"),n.setRequestHeader("Content-Type","application/json"),n.addEventListener("load",function(){if(200<=n.status&&n.status<300){var e=JSON.parse(n.responseText);funnelytics.session=e.id,funnelytics.cookies.set(funnelytics.cookie,funnelytics.session),funnelytics.functions.step(),funnelytics.projects.addCrossDomainParameters()}}),n.send(JSON.stringify({project:funnelytics.project,page:window.location.href,device:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?"mobile":"desktop"}))}},step:function(){if(!funnelytics.client.isBot())if(funnelytics.session){var e=null;funnelytics.isSPA&&0<funnelytics.steps.length&&(e=funnelytics.steps[funnelytics.steps.length-1]),funnelytics.steps.push(window.location.href);var n=new XMLHttpRequest;n.open("POST",funnelytics.origin+"/steps"),n.setRequestHeader("Content-Type","application/json"),n.addEventListener("load",function(){200<=n.status&&n.status<300&&(funnelytics.step=JSON.parse(n.responseText).id)}),n.send(JSON.stringify({project:funnelytics.project,session:funnelytics.session,page:window.location.href,referrer:document.referrer,recorded:e}))}else funnelytics.functions.initialize()}},init:function(e,n){funnelytics.isSPA=n||!1,funnelytics.project=e,funnelytics.session=funnelytics.getSession(),funnelytics.session?(1!=n&&funnelytics.functions.step(),funnelytics.projects.addCrossDomainParameters()):e&&funnelytics.functions.initialize(),!0===window.funnelytics_queued&&funnelytics.functions.step()}};